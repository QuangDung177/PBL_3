@{
    ViewBag.Title = "Revenue";
    Layout = "~/Areas/Admin/Views/Shared/AdminLayoutPage1.cshtml";
}
<head>
    <!-- Thêm Chart.js từ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Thêm jQuery từ CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<style>
    .row_element-button {
        display: flex;
        flex-wrap: wrap;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 10px;
        text-align: left;
        text-size-adjust: 100%;
        justify-content: space-between;
    }

    .widget-small {
        display: flex;
        background-color: white;
        padding: 10px;
        border-radius: .375rem;
    }

    .icon {
        border-radius: .375rem;
        width: 60px;
        height: 72px;
    }

        .icon svg {
            color: white;
        }

    .info {
        padding-left: 20px;
        color: red;
    }

    .btn-choice {
        background-color: rgb(208, 208, 208);
    }

    .btn:hover {
        opacity: 0.8;
        background-color: #00FFFF;
    }

    .hidden {
        display: none;
    }
</style>
<main class="main">
    <div class="main_title">
        <p class="main_title-label"><b>Thống kê doanh thu</b></p>
        <div id="clock"></div>
    </div>
    <div class="row" style="margin-left: 20px; padding-bottom: 20px;">
        <div class="col-md-6 col-lg-3">
            <div class="widget-small primary coloured-icon">
                <div class="icon" style="background-color: rgb(249, 186, 186);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-person-fill" viewBox="-2 -2 20 16">
                        <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                    </svg>
                </div>
                <div class="info">
                    <h4>Tổng Nhân viên</h4>
                    <p style="color: black;"><b> @ViewBag.Stafftotal nhân viên</b></p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="widget-small primary coloured-icon">
                <div class="icon" style="background-color: rgb(173, 203, 243);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-tag-fill" viewBox="-2 -2 20 16">
                        <path d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                    </svg>
                </div>
                <div class="info">
                    <h4>Tổng sản phẩm</h4>
                    <p style="color: black;"><b>@ViewBag.Producttotal sản phẩm</b></p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="widget-small primary coloured-icon">
                <div class="icon" style="background-color: rgb(253, 225, 195);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-bag" viewBox="-2 -2 20 16">
                        <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z" />
                    </svg>
                </div>
                <div class="info">
                    <h4>Tổng đơn hàng</h4>
                    <p style="color: black;"><b>@ViewBag.Ordertotal đơn hàng</b></p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="widget-small primary coloured-icon">
                <div class="icon" style="background-color: rgb(185, 255, 211);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-graph-up" viewBox="-2 -2 20 16">
                        <path fill-rule="evenodd" d="M0 0h1v15h15v1H0zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07" />
                    </svg>
                </div>
                <div class="info">
                    <h4>Tổng doanh thu</h4>
                    <div style="display:flex">
                        <p class="totalrevenue" style="color: black; margin-right: 5px;"><b><span class="number">@ViewBag.TotalRevenue</span></b></p>
                        <p style="color: black;"><b><span>đồng</span></b></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="title" id="content">
                <div class="row_element-button">
                    <div>
                        <label><i>Thống kê theo:</i> </label>
                        <button class="btn btn-choice" id="btn-time">Thời gian</button>
                        <button class="btn btn-choice" id="btn-staff">Nhân viên</button>
                        <button class="btn btn-choice" id="btn-product">Sản phẩm</button>
                    </div>

                    <div>
                        <form class="d-flex align-items-center">
                            <label for="ngaybatdau" class="mx-2 my-1" style="white-space: nowrap;">Ngày bắt đầu</label>
                            <input class="form-control mx-2 my-1" type="date" id="ngaybatdau" name="ngaybatdau" placeholder="Ngày bắt đầu" required>
                        </form>
                    </div>
                    <div>
                        <form class="d-flex align-items-center">
                            <label for="ngayketthuc" class="mx-2 my-1" style="white-space: nowrap;">Ngày kết thúc</label>
                            <input class="form-control mx-2 my-1" type="date" id="ngayketthuc" name="ngayketthuc" placeholder="Ngày kết thúc" required>
                        </form>
                    </div>

                </div>
                <div class="timefields hidden">
                    <canvas id="myChart" width="800" height="400"></canvas>
                </div>
                <div class="stafffields hidden">
                    <table class="table table-hover table-bordered js-copytextarea" cellpadding="0" cellspacing="0" border="0" id="sampleTable1">
                        <thead>
                            <tr>
                                <th width="100">ID nhân viên</th>
                                <th width="200">Tên nhân viên</th>
                                <th width="100">Số lượng xác nhận</th>
                                <th width="100">Tổng doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="productfields hidden">
                    <table class="table table-hover table-bordered js-copytextarea" cellpadding="0" cellspacing="0" border="0" id="sampleTable">
                        <thead>
                            <tr>
                                <th width="100">ID sản phẩm</th>
                                <th width="200">Tên sản phẩm</th>
                                <th width="100">Màu sắc</th>
                                <th width="100">Thương hiệu</th>
                                <th width="100">Loại sản phẩm</th>
                                <th width="100">Số lượng bán</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>
<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts\jquery-3.7.1.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        var myChart; // Biến để lưu trữ tham chiếu đến biểu đồ
        function getAndValidateDates() {
            var startDate = $('#ngaybatdau').val();
            var endDate = $('#ngayketthuc').val();

            if (new Date(startDate) >= new Date(endDate)) {
               
                swal("", "Ngày bắt đầu phải trước ngày kết thúc.", "error");
                return null;
            }

            return { startDate: startDate, endDate: endDate };
        }
        function setStaffExportTable() {
            var dates = getAndValidateDates();
            if (!dates) return;

            $.ajax({
                url: '/Admin/Staff/GetStaffExport', // Thay đổi URL theo cần thiết
                type: 'GET',
                data: {
                    startDate: dates.startDate,
                    endDate: dates.endDate
                },
                success: function (data) {
                    var tbody = $('#sampleTable1 tbody');
                    tbody.empty(); // Xóa tbody hiện tại

                    $.each(data, function (index, item) {
                        var row = $('<tr>');
                        row.append($('<td>').text(item.StaffID));
                        row.append($('<td>').text(item.FullName));
                        row.append($('<td>').text(item.DeliveredQuantity));
                        row.append($('<td>').text(item.TotalRevenue));

                        tbody.append(row);
                    });
                },
                error: function (error) {
                    console.error('Error fetching staff exports:', error);
                }
            });
        }

        $('#btn-staff').click(function () {
            setStaffExportTable();
        });
        function setproducttable() {
            var dates = getAndValidateDates();
            if (!dates) return;
            $.ajax({
                url: '/Product/Getsoldproduct', // Thay đổi URL theo cần thiết
                type: 'GET',
                data: {
                    startDate: dates.startDate,
                    endDate: dates.endDate
                },
                success: function (data) {
                    var tbody = $('#sampleTable tbody');
                    tbody.empty(); // Xóa tbody hiện tại

                    $.each(data, function (index, item) {
                        var row = $('<tr>');
                        row.append($('<td>').text(item.ProductID));
                        row.append($('<td>').text(item.Name));
                        row.append($('<td>').text(item.Color));
                        row.append($('<td>').text(item.Brand));
                        row.append($('<td>').text(item.Type));
                        row.append($('<td>').text(item.QuantitySold));

                        tbody.append(row);
                    });
                },
                error: function (error) {
                    console.error('Error fetching sold products:', error);
                }
            });
        }
       
        // Hàm xử lý gửi yêu cầu AJAX
        function sendAjaxRequest() {
            // Lấy ngày bắt đầu và kết thúc từ input
          
            var dates = getAndValidateDates();
            if (!dates) return;
            // Gửi yêu cầu AJAX với tham số startDate và endDate
            $.ajax({
                url: '/AHome/Chart', // Thay đổi URL thành đường dẫn cụ thể của hành động Chart trong AHomeController của bạn
                type: 'GET',
                data: {
                    startDate: dates.startDate,
                    endDate: dates.endDate }, // Truyền tham số vào đây
                dataType: 'json',
                success: function (data) {
                    // Khởi tạo mảng chứa dữ liệu các tháng và doanh thu tương ứng
                    var labels = [];
                    var revenues = [];

                    // Lặp qua dữ liệu trả về từ hàm Chart() để lấy các giá trị
                    for (var i = 0; i < data.length; i++) {
                        labels.push('Tháng ' + data[i].Month); // Thêm tên tháng vào mảng labels
                        revenues.push(data[i].Revenue); // Thêm doanh thu vào mảng revenues
                    }

                    // Kiểm tra nếu biểu đồ đã được tạo trước đó, thì xóa nó
                    if (myChart) {
                        myChart.destroy();
                    }

                    // Tạo biểu đồ bar mới
                    var ctx = document.getElementById('myChart').getContext('2d');
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Doanh thu theo tháng',
                                data: revenues,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },
                error: function () {
                    console.log('Đã xảy ra lỗi khi lấy dữ liệu doanh thu từ server.');
                }
            });
        }

        // Lắng nghe sự kiện click của nút thời gian và gọi hàm xử lý
        $('#btn-time').click(function () {
            sendAjaxRequest();
        });
        $('#btn-product').click(function () {
            setproducttable();
        });
        // JavaScript để xử lý sự kiện click và hiển thị/ẩn các thẻ
        $('#btn-time').click(function () {
            $('.timefields').removeClass('hidden');
            $('.stafffields').addClass('hidden');
            $('.productfields').addClass('hidden');
        });

        $('#btn-staff').click(function () {
            $('.timefields').addClass('hidden');
            $('.stafffields').removeClass('hidden');
            $('.productfields').addClass('hidden');
        });

        $('#btn-product').click(function () {
            $('.timefields').addClass('hidden');
            $('.stafffields').addClass('hidden');
            $('.productfields').removeClass('hidden');
        });
    });


    document.addEventListener('DOMContentLoaded', function () {
        formatNumbers('totalrevenue');
    });
</script>
